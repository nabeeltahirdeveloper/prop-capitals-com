server {
    listen       80;
    server_name  _;

    root  /usr/share/nginx/html;
    index index.html;

    # Docker's embedded DNS — needed so proxy_pass with a variable resolves
    # the backend container name at request time rather than only at startup.
    resolver 127.0.0.11 valid=30s ipv6=off;

    # ── Compression ──────────────────────────────────────────────────────────
    gzip            on;
    gzip_vary       on;
    gzip_proxied    any;
    gzip_comp_level 6;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        image/svg+xml
        font/woff
        font/woff2;

    # ── Socket.io WebSocket proxy ─────────────────────────────────────────────
    # Handles both the initial HTTP polling handshake and the WS upgrade.
    # Using a variable forces Nginx to re-resolve the upstream on every request.
    location /socket.io/ {
        set $backend http://backend:5101;
        proxy_pass $backend;

        proxy_http_version 1.1;
        proxy_set_header Upgrade    $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host       $host;
        proxy_set_header X-Real-IP  $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_read_timeout  3600s;
        proxy_send_timeout  3600s;
        proxy_cache_bypass  $http_upgrade;
    }

    # ── Backend REST API proxy ────────────────────────────────────────────────
    # All known NestJS route prefixes are forwarded to the backend container.
    # The browser never has to open a cross-origin connection to port 5101.
    location ~* ^/(auth|users|admin|trades|trading-accounts|challenges|payouts|payments|notifications|coupons|contact|chat|crm|economic-calendar|support-tickets|market-data|prices|wallets|pending-orders|broker-servers|evaluation|external-api) {
        set $backend http://backend:5101;
        proxy_pass $backend;

        proxy_http_version 1.1;
        proxy_set_header Connection      "";
        proxy_set_header Host            $host;
        proxy_set_header X-Real-IP       $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # Allow streaming / SSE responses to flow through without buffering
        proxy_buffering       off;
        proxy_read_timeout    300s;
        proxy_connect_timeout 10s;
    }

    # ── Immutable static assets (Vite adds content hashes to filenames) ───────
    location ~* \.(js|css|woff|woff2|ttf|eot|otf)$ {
        expires    1y;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location ~* \.(png|jpg|jpeg|gif|ico|svg|webp)$ {
        expires    6M;
        add_header Cache-Control "public";
        access_log off;
    }

    # ── SPA catch-all — all remaining paths serve index.html ─────────────────
    location / {
        try_files $uri $uri/ /index.html;

        location = /index.html {
            add_header Cache-Control "no-cache, no-store, must-revalidate";
            add_header Pragma        "no-cache";
            add_header Expires       "0";
        }
    }

    # ── Security headers ─────────────────────────────────────────────────────
    add_header X-Frame-Options        "SAMEORIGIN"  always;
    add_header X-Content-Type-Options "nosniff"     always;
    add_header X-XSS-Protection       "1; mode=block" always;
    add_header Referrer-Policy        "strict-origin-when-cross-origin" always;
}
